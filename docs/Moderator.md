# ゲームの進行
## ルールの簡単な説明
推奨BGM: G線上のアリア BWV 1068（バッハ作曲、ウィルヘルミ編曲）

実際の盤面を使いつつルールの簡単な確認を行ってください。

## オープニング
推奨BGM: フーガ ト短調 BWV 578 （バッハ作曲）

[オープニング台本](resources/HandOuts/Opening.pdf)の読み合わせをお願いします。

## 調査・密談・全体会議
カード調査や会話を行うフェーズです。

PC番号順に、「誰が調査組（2人）に行き、誰が居残り組（3人）に残るか」を指名していきます。この時、全体会議（全員居残り組）を選ぶこともできます。指名された組み合わせに分かれて5分がすぎると、次のプレイヤーが組み合わせを指名します。条件を満たしたプレイヤー（カードを入手した、必要な情報を揃えた、など）が、追加情報を求めてきますので、[追加情報の管理](AdditionalInfos.md)を参考にしてください。


プレイヤー5人全員が指名を終えると（5分×5回 = 25分）、休憩5分間が入ります。この5分間はトイレ休憩のほか、追加ハンドアウトを読む時間を想定しています。GMの裁量で雑談禁止にしたり、短縮・延長したりしても問題ありません。また、情報量の多い追加ハンドアウトを渡した後は、GMと1分間程度の話す時間を設けることも検討してください。

25分間の調査・会話+5分間の休憩を1フェーズとして、4フェーズあります。

### 休憩
推奨BGM: ピアノソナタ8番 ハ短調 op.13「悲愴」第三楽章 （ベートーヴェン作曲）

追加情報を読み込む時間として頻回に休憩をとっています。

### 第1フェーズ
推奨BGM: 交響曲第3番 変ホ長調 作品55『英雄』（ベートーヴェン作曲）

> 調査・密談・全体会議には4フェーズあり、各5回、調査組と居残り組に分かれて5分間行動します。カード調査ができるのはこのうち調査組だけです。組みわけは、PC番号順に各プレイヤーが1回ずつ指名していきます。つまり、シンフォニー、セレナーデ、ララバイ、キャロル、カプリッチオの順に指名しますので、誰を指名するのかあらかじめ考えておいてください。この際、自分ともう一人で調査組になってもいいですし、自分以外の2人を調査組に指名してもかまいません。また、全体会議を選ぶこともできますが、この場合カード調査を行うことはできません。

> では、カード調査の方法について説明します。盤面中央、「フーガの部屋」の一番左のカードをご覧ください。一番血まみれのカードです。下に星が二つ付いています。

> カード調査には調査ポイントを消費します。シンフォニー、自分のところに虫眼鏡のマーカーがあるのはわかりますか？　ではシンフォニー、先ほどの血まみれのカードの左下の星に、調査ポイントを移動してください。ありがとうございます。この状態は、シンフォニーが調査をしている途中のため、シンフォニー含めてカードを見ることはできません。

>次にキャロル、右の星に調査ポイントをおいてください。ありがとうございます。この状態は、シンフォニーが調査に協力して、キャロルが調査を完了した形になります。調査が完了した時点で、カードを見ることができるようになります。この場合、カードを見ることができるのはキャロルとシンフォニーです。見るときは自分だけ見る、で閲覧してください。

> 次にカードの所有に関して説明します。現在、このカードを所有しているのはキャロルだけです。所有者であるキャロルはカードの効果の使用、全体交換や譲渡ができます。ということで、キャロルがララバイにカードを譲渡したとしましょう。全体公開されていないカードを譲渡するには、一番右の調査ポイントを入れ替えます。ということで、キャロルの調査ポイントをララバイの調査ポイントと交換してください。ありがとうございます。これでカードの所有権が移動しました。

> このマーダーミステリーではこっそり見せる、ということはできません。しかし、一時的に譲渡することでこっそり見せる、に近いことは可能です。ララバイはカードをセレナーデに譲渡してもらってもいいですか？　セレナーデはカードを確認してください。さて、セレナーデはこのカードをララバイへ返却する義務はありません。セレナーデ、カードをララバイへ譲渡しますか？　

> （カードを譲渡した場合）ララバイ、返してもらってよかったですね。他のPLが信用できない場合は返してもらえない可能性も考えておきましょう。

> （カードを譲渡されなかった場合）このように、他のPLが信用できない場合も多々ありますので、ご注意ください。

> （以下、カードが譲渡されなかったら、ララバイをセレナーデに読み替える）

> さて、カードを全体公開することができるのも所有者だけです。では、ララバイ「全体に公開する」で全体公開してもらってもいいですか？　ありがとうございます。カードを全体公開すると、調査ポイントが各プレイヤー1つだけ戻ってきます。もしこのカードに2つ以上調査ポイントをおいていた場合、ほかの調査ポイントはここに置き去りになります。では、シンフォニーとララバイは調査ポイント1ptずつを自分の手元に戻してください。また、ララバイは、横長でララバイと書かれたマーカーを先ほど全体公開したカードの下に移動してください。これは、全体公開した後も、ララバイが所有者であることを示すためのマーカーです。

> カードが全体公開になったところで、全体公開のカードの譲渡についてお話しします。全体公開のカードは横長のマーカーを入れ替えるだけですみます。ということでララバイはカプリッチオにカードを譲渡してください。

> さて、一回の調査で調査できる上限があります。具体的に言うと、2人合わせて3ptまでしか調査できません。この内訳は1と2で分担してもいいですし、一人だけで3pt消費してもかまいません。これはあくまで上限ですので、消費しないのも選択肢です。

> 以上でカード調査の説明を修了します。何かご不明な点はありますか？

> でしたら、第1フェーズ開始します。

> 日の出頃の街はまだ青色で、外から聞こえるのは小鳥のさえずりだけである。重い口を最初に開いたのは、シンフォニーであった。

> シンフォニーさん、誰が調査組に行き、誰が居残り組に残るかを指名してください。全体会議を選ぶこともできます。

（以降、セレナーデ、ララバイ、キャロル、カプリッチオの順に指名していく）

### 第2フェーズ
推奨BGM: 24の奇想曲 第24番 イ短調 （パガニーニ作曲）

> 通勤中だろうか、隠れ家の外からは車の通る音がする。車道に差す朝日が、夜の冷え切った空気を少しずつ暖め始めていた。そこをもう一台車が通った。少しずつ活気を取り戻す朝の空気のなか、話し合いは熱を帯びていった。

> ルールは第1フェーズと同様です。シンフォニーさん、指名をお願いします。

### 第3フェーズ
推奨BGM: セレナード （シューベルト作曲）

> リビング・ダイニングを夕日が照らす。知りたいことも知りたくないことも知ってしまった。それでも、考え続けなければならないようだった。

> シンフォニーさん、指名をお願いします。

### 第4フェーズ
推奨BGM: コヴェントリー・キャロル　（作者不明）

> 調査・密談・全体会議ができる最後のフェーズです。この後は、推理、最終投票、エンディングのみとなっています。

> 第4フェーズに移る前に、余った調査ポイントについてお話しします。

> まず調査ポイントと投票権の交換についてお話しします。投票フェーズでは犯人・リーダーそれぞれの投票を行うのですが、現時点で皆さんはそれぞれの投票について1票ずつ所有します。しかし調査ポイント4ptを捨てることで、投票権を2票ずつにすることが可能ですので、希望者は第4フェーズ終了後、お伝えください。また、同票となった場合は残り調査ポイント数が多い人の方が有利になります。

> エンディングでも調査ポイントは使用価値があります。エンディングでは行動順、というものがあり、物語に決着がつくまでターンを繰り返します。リーダーが最初、犯人が最後なのですが、他の人は残り調査ポイント数が多い人の方が速いです。

> 要するに、調査ポイントは余っていても使用価値があります。一方で、これがカードの全体公開、カードや調査ポイントの譲渡について相談できる最後のフェーズです。したがって、投票・エンディングのことも考えて話し相手を選んでください。

> 何か質問はありますか？

> 日は沈んだ。真相に近づきつつある一同は、あまり時間が残されていないことに気が付いていた。

> シンフォニーさん、指名をお願いします。

#### 第4フェーズ終了後

> マイクをミュートして下さい。今から、投票権と調査ポイントの交換を行います。調査ポイント4ptを捨てることで、リーダー投票・犯人投票の票が1票ずつ増えます。投票権と調査ポイントを交換したい、という人のみマイクミュートを解除して発言をお願いします。なお、カードの全体公開は今でもできますが、全体公開の相談はできません。カードの譲渡、調査ポイントの譲渡はできません。

> （1分程度待ってから）それではこれで投票権の交換を締め切ります。

・タイマーを使って締め切ると、最後の一秒に交換しようとするPLが現れる。最後に誰かが購入したのち1分程度待ってから締め切るのがフェアだろう。

## 推理発表・投票
推奨BGM: カノン （パッヘルベル作曲）

> いまだ話したりない一同を、月明かりが急かす。もう時間はないのだ。

> ここで推理発表、投票を説明します。

> まず、プレイマットの右下、ロゴの上をご覧ください。

ここで、**犯人投票**と**リーダー投票**のカードを公開し、読み上げる。

> リーダーはリーダー権限により、カードを一枚強制的に奪うことができます。犯人は拘束されてしまい行動ができませんし、エンディングでカードが奪われそうになっても抵抗ができません。死亡した場合も同様です。なお、リーダー権限の使用や拘束の解除はそれぞれ1ターン消費するとして扱います。

> 推理発表では**PC番号順**に**犯人として誰を拘束するべきか**を中心に話していただきます。リーダー投票に関しては話してはいけませんが、その他のことについては触れていただいてもかまいません。後から話す人は前に話した人へ反論してもかまいません。その後、各キャラクター用のテキストチャンネルに回答フォームを送りますので、記入をお願いします。こちらに関しては自投票可能です。

> 以上で説明を終わりにします。何か、質問はありますか？

以下、卒業式のような厳粛さで、

> それでは、最終投票に移ります。PC番号1番、シンフォニー。推理をお願いします。

- 犯人投票とリーダー投票を行います。
- PC番号順に自分の犯人投票先の発表とその根拠を話していきます。
- 全員分の推理が終わったら、全員ミュートにするように促してください。
- 以下のボタンは投票先に加え、BONUS事項を記載したものがコピーできるボタンです。ご活用ください。
- 同票処理に関しては[ルール補足](AdditionalInfos.md)をご確認ください。

|キャラクター|BONUSミッション|コピー用ボタン|
|:-:|:-:|:-:|
|シンフォニー|図書館員殺人の犯人は誰ですか？（2点）|<button onclick="copyhidden('Symphony')">コピー</button>|
|セレナーデ|アオイは夏音で何をしていましたか？（2点）|<button onclick="copyhidden('Serenade')">コピー</button>|
|ララバイ|ほかの人は南西飛び地をどう思っていますか？（各0.5点）|<button onclick="copyhidden('Lullaby')">コピー</button>|
|キャロル||<button onclick="copyhidden('Carol')">コピー</button>|
|カプリッチオ|アリアは今、何をしていますか？（2点）|<button onclick="copyhidden('Capriccio')">コピー</button>|
<p></p>
 <div id="Symphony" hidden>シンフォニー</br>
1. 犯人投票は誰に入れますか？</br>
2. リーダー投票は誰に入れますか？</br>
3. BONUS: 図書館員殺人の犯人は誰ですか？（2点）</br>
（投票先は、先ほど発表した人間と別でも問題ありません）
</div>

 <div id="Serenade" hidden>セレナーデ</br>
1. 犯人投票は誰に入れますか？</br>
2. リーダー投票は誰に入れますか？</br>
3. BONUS: アオイは夏音で何をしていましたか？
</div>

 <div id="Lullaby" hidden>ララバイ</br>
1. 犯人投票は誰に入れますか？</br>
2. リーダー投票は誰に入れますか？</br>
3. BONUS: ほかの人は南西飛び地をどう思っていますか？
シンフォニー:</br>
セレナーデ:	</br>
キャロル:</br>
カプリッチオ:
</div>

 <div id="Carol" hidden>キャロル</br>
1. 犯人投票は誰に入れますか？</br>
2. リーダー投票は誰に入れますか？ 
</div>

 <div id="Capriccio" hidden>カプリッチオ</br>
1. 犯人投票は誰に入れますか？</br>
2. リーダー投票は誰に入れますか？ </br>
3. BONUS: アリアは今、何をしていますか？
</div>



<script>
function copyhidden(name){
  //create new div
  const hiddenDiv = document.getElementById(name);
  const newDiv = document.createElement("div");
  hiddenDiv.parentNode.insertBefore(newDiv, hiddenDiv.nextSibling);
  newDiv.innerHTML = hiddenDiv.innerHTML;
  let range = document.createRange();
  range.selectNodeContents(newDiv);

  //copy
  let selection = document.getSelection();
  selection.removeAllRanges();
  selection.addRange(range);

  document.execCommand('copy');
  selection.removeAllRanges();

  // delete new div
  newDiv.parentNode.removeChild(newDiv);
}
</script>

## エンディング
推奨BGM: 子守歌（シューベルト作曲）/ 旧支配者のキャロル

> 投票の集計が終わりました。先ほどお伝えした通り、エンディングの行動順はリーダーが最初、犯人が最後です。つきましては、結果発表に代えまして、行動順の発表を行います。

行動順を発表する。

> この行動順に沿って、皆さんは行動を何か一つとることができます。カードに書かれた効果を使ってもいいですし、カードに書かれていなくても、このアイテムならこんなことができそう、と提案してくださってもかまいません。手ごろなカードがなければ「他のプレイヤーを殴る」といった行動でもいいでしょう。また、他のプレイヤーから攻撃された場合は抵抗もできます。が、相手がアイテムの効果を使用している場合、抵抗は失敗することが多いでしょう。また、カードを奪うことも可能ですが、この時、調査ポイントを1ptだけ消費します。

> その時ターンでないPLもRPしてくださってかまいませんが、行動の宣言が終了してからにしてください。また、犯人役の○○は猿ぐつわが噛まされているため、指を口に咥えてのRPをお願いします。

> 今から数分間の選択一つひとつが、この物語の終わり方を左右します。よくよく考えて行動してください。

> 南の空高く、<ruby>橙<rp>（</rp><rt>だいだい</rt><rp>）</rp></ruby>色の星が<ruby>瞬<rp>（</rp><rt>またた</rt><rp>）</rp></ruby>いている。物語の行く末を見守るように。

> リーダーの○○、どういう行動を取りますか？

- 投票結果に応じて、プレイヤーが順番に行動します。
- 順番が来たプレイヤーは、「何らかの行動を1つ」とることができます。具体的な基準は示しませんが、あまりに複雑な行動は禁止してください。例えば「ほかのキャラクターを殺してアイテムを奪う」は1つですが、「そのアイテムを使う」までは別の行動とみなします。

エンディングで想定される行動とその帰結は「エンディングのイベント」を参照してください。

### エンディングの行動順

<div>1. リーダー（1回目）</div><div>
2~4. </div><div>
　A. リーダー、犯人は除外</div><div>
　B. 調査ポイントが多い順</div><div>
　C. PC番号順</div><div>
5. 犯人（拘束を他プレイヤーが解いた場合のみ行動できる）</div>
<p></p>

以降、繰り返し。

### 行動順計算ツール

半角数字で入力してください。雑に作っているので、それ以外の数字を入れると容易にバグります。

<script src="https://cdn.jsdelivr.net/npm/vue@2.5.16/dist/vue.js"></script>

<div id="app">

<h3> 投票先入力 </h3>

<table>
  <thead>
  <tr>
    <th></th>
    <th>投票権</th>
    <th>調査pt</th>
    <th>犯人</th>
    <th>リーダー</th>
  </tr>
  </thead>
  <tbody>
  <tr v-for="character in characters" :key="character.id" >
    <td>{{ character.name }}</td>
    <td><input size="3" v-model.number="character.ballot_cnt"></td>
    <td><input size="3" v-model.number="character.left_pt"></td>
    <td>
      <select v-model.number="character.vote_mud">
        <option v-for="char_choice in characters" v-bind:value="char_choice.id">{{ char_choice.name }}</option>
      </select>
  </td>
  <td>
      <select v-model.number="character.vote_ldr">
        <option v-for="char_choice in characters" v-bind:value="char_choice.id">{{ char_choice.name }}</option>
      </select>
  </td>
  </tr>
  </tbody>
</table>

<h3> 票数集計 </h3>

<table>
  <thead>
  <tr>
    <th></th>
    <th>調査pt</th>
    <th>犯人</th>
    <th>リーダー</th>
    <th>犯人*pt</th>
    <th>リーダー*pt</th>
  </tr>
  </thead>
  <tbody>
  <tr v-for="character in characters" :key="character.id" >
    <td>{{ character.name }}</td>
    <td>{{ character.left_pt }}</td>
    <td>{{ chr_votes.sum_mud[character.id]}}</td>
    <td>{{ chr_votes.sum_ldr[character.id]}}</td>
    <td>{{ chr_votes.sum_mud_pt[character.id]}}</td>
    <td>{{ chr_votes.sum_ldr_pt[character.id]}}</td>
  </tr>
  </tbody>
</table>

<h3> 行動順 </h3>

<table>
  <thead>
  <tr>
    <th>行動順</th>
    <th>キャラクター</th>
  </tr>
  </thead>
  <tbody>
  <tr>
    <td>リーダー</td>
    <td>{{ chr_order[0].name }}</td>
  </tr>
  <tr>
    <td>2</td>
    <td>{{ chr_order[1].name }}</td>
  </tr>
  <tr>
    <td>3</td>
    <td>{{ chr_order[2].name }}</td>
  </tr>
  <tr>
    <td>4</td>
    <td>{{ chr_order[3].name }}</td>
  </tr>
  <tr>
    <td>犯人</td>
    <td>{{ chr_order[4].name }}</td>
  </tr>
  </tbody>
</table>

</div>

<script>

function compare_list(a, b){
  if (a.length !== b.length) {
    console.log(a, b)
    throw 'Array should be the same length!'
  }
  if (a.length === 0) return 0;
  if (a[0] > b[0]) return 1;
  if (a[0] < b[0]) return -1;

  if (a.length === 1) return 0;
  return compare_list(a.slice(1), b.slice(1))
}

let app = new Vue({
  el: "#app",
  data:{
    characters : [
      {id: 0, name: "シンフォニー" , ballot_cnt: 1, left_pt: 0, vote_mud: 0, vote_ldr: 0}, 
      {id: 1, name: "セレナーデ"   , ballot_cnt: 1, left_pt: 0, vote_mud: 0, vote_ldr: 0}, 
      {id: 2, name: "ララバイ"     , ballot_cnt: 1, left_pt: 0, vote_mud: 0, vote_ldr: 0}, 
      {id: 3, name: "キャロル"     , ballot_cnt: 1, left_pt: 0, vote_mud: 0, vote_ldr: 0}, 
      {id: 4, name: "カプリッチオ" , ballot_cnt: 1, left_pt: 0, vote_mud: 0, vote_ldr: 0}
  ],
  },
  computed: {
    chr_votes: function(){
      let result = {
        sum_mud: [0, 0, 0, 0, 0], // sum(vote_mud)
        sum_ldr: [0, 0, 0, 0, 0], // sum(vote_ldr)
        sum_mud_pt:[0, 0, 0, 0, 0], // sum(vote_mud*left_pt)
        sum_ldr_pt: [0, 0, 0, 0, 0]  // sum(vote_ldr*left_pt)
      }; 

      for (character of this.characters) {
        result.sum_mud[character.vote_mud] += character.ballot_cnt;
        result.sum_ldr[character.vote_ldr] += character.ballot_cnt;
        result.sum_mud_pt[character.vote_mud] += character.ballot_cnt * character.left_pt;
        result.sum_ldr_pt[character.vote_ldr] += character.ballot_cnt * character.left_pt;
      }
      return result
    },
    mud_vote_order: function(){
      var result = [];
      for (character of this.characters){
        var cid = character.id
        var chr_votes = this.chr_votes
        result.push([ // the better: be likely to be chosen
          -chr_votes.sum_mud[cid],   // bigger the better
          character.left_pt,         // smaller the better
          -chr_votes.sum_mud_pt[cid],// bigger the better
          cid,                       // smaller the better
          0                          // murderer is the better
        ]);
      }
      return result;
    },
    ldr_vote_order: function(){
      var result = [];
      for (character of this.characters){
        var cid = character.id
        var chr_votes = this.chr_votes
        result.push([ // the better: be likely to be chosen
          -chr_votes.sum_ldr[cid],    // bigger the better
          -character.left_pt,         // bigger the better
          -chr_votes.sum_ldr_pt[cid], // bigger the better
          cid,                        // smaller the better
          1                           // murderer is the better
        ]); 
      }
      return result;
    },
    chr_order: function(){
      var first_priority = this.mud_vote_order.concat(this.ldr_vote_order).sort(compare_list)
      // console.log(first_priority)
      first_priority = first_priority[0]
      if (first_priority[4] === 0) {
        var mud = this.characters[first_priority[3]];
        var ldr = this.characters[
          this.ldr_vote_order.filter(c => mud.id !== c[3]).sort(compare_list)[0][3]
        ];
      } else {
        var ldr = this.characters[first_priority[3]];
        var mud = this.characters[
          this.mud_vote_order.filter(c => ldr.id !== c[3]).sort(compare_list)[0][3]
        ];
      }
      var others = this.characters.filter(c => ![mud.id, ldr.id].includes(c.id))
      others.sort((a, b) => -(a.left_pt - b.left_pt));
      return [ldr].concat(others,[mud]) }
  }
})

</script>